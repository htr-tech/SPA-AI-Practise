<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/icon" href="misc/favicon.ico" />
  <title>SPA Template</title>

  <!-- Css for Index File -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="css/theme.misc.css">
  <link rel="stylesheet" href="css/theme.sidebar.css">
  <link rel="stylesheet" href="css/theme.password.css">

  <!-- Stylesheets -->
  <link rel="stylesheet" href="css/tools.flagquiz.css">
  <link rel="stylesheet" href="css/tools.idiomdict.css">

  <style>
    :root {
      /* Dark theme colors */
      --bg-primary: #121212;
      --bg-secondary: #1e1e1e;
      --bg-card: #252525;
      --bg-modal: #1a1a1a;
      --bg-nav: #0c0c0c;
      --accent-primary: #8c52ff;
      --accent-secondary: #5e72e4;
      --text-primary: #f8f9fa;
      --text-secondary: #b0b6bc;
      --text-tertiary: #7d8597;
      --card-shadow: 0 8px 16px #0000004d;
      --card-hover: #323232;
      --success: #2dce89;
      --warning: #fb6340;
      --error: #f5365c;
      --info: #11cdef;
      --ring: 0 0 0 3px rgb(140 82 255 / 25%);
      --radius: 14px;
    }

    /* Light theme colors */
    html[data-theme="light"] {
      --bg-primary: #f5efff;
      --bg-secondary: #e7dcff;
      --bg-card: #ffffff;
      --bg-modal: #f2eaf8;
      --bg-nav: #d7caff;
      --accent-primary: #8c7ae6;
      --accent-secondary: #6c5ce7;
      --accent-tertiary: #a29bfe;
      --text-primary: #2d2d2d;
      --text-secondary: #5c5c7a;
      --text-tertiary: #8a8aab;
      --card-shadow: 0 4px 12px #6a11cb0d;
      --card-hover: #ffffff;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, Segoe UI, Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: var(--bg-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 0;
      overflow-x: hidden;
      color: var(--text-primary);
    }

    @supports (min-height: 100svh) {
      body {
        min-height: 100svh;
      }
    }

    @media (max-width: 768px) {
      body {
        min-height: 100svh;
        padding-bottom: calc(70px + env(safe-area-inset-bottom, 0px));
      }
    }

    .container {
      background-color: color-mix(in srgb, var(--bg-secondary) 90%, transparent);
      border-radius: var(--radius);
      box-shadow: var(--card-shadow);
      border: 1px solid color-mix(in srgb, var(--accent-primary) 15%, transparent);
      width: 100%;
      padding: 30px;
      max-width: 1200px;
      margin: 20px auto;
      flex: 1;
      backdrop-filter: saturate(120%) blur(2px);
    }

    @media (max-width: 768px) {
      .container {
        margin: auto;
        border-radius: 0;
      }
    }

    .nav-container {
      display: flex;
      flex-direction: column;
      min-height: 100%;
    }

    @media (min-width: 769px) {
      .nav-container {
        flex-direction: row;
      }
    }

    h1 {
      text-align: center;
      color: var(--text-primary);
      margin-bottom: 20px;
      font-size: 28px;
      letter-spacing: .2px;
    }

    .rainbow-text {
      background: linear-gradient(45deg, #e63f3f, #df8d14, #51ee51, #5b5be9, #9b36df);
      background-size: 300% 300%;
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      animation: prideAnimation 8s ease infinite;
    }

    @keyframes prideAnimation {
      0% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    .content-section {
      display: none;
      animation: fadeIn 0.5s;
    }

    .content-section.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(4px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }


    /* theme switcher */
    .icon-toggle {
      position: relative;
      font-size: 0;
      outline: none;
    }

    .icon-toggle:focus-visible {
      box-shadow: var(--ring);
    }

    #theme-toggle-desktop::before,
    #theme-toggle-mobile::before {
      font: var(--fa-font-solid);
      font-size: 18px;
      line-height: 1;
      display: inline-block;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      content: "\f186";
    }

    html[data-theme="light"] #theme-toggle-desktop::before,
    html[data-theme="light"] #theme-toggle-mobile::before {
      content: "\f185";
    }

    .sidebar-nav-icon i,
    .mobile-nav-icon i {
      font-size: 18px;
    }
  </style>
</head>

<body>
  <div class="nav-container">
    <!-- Desktop Sidebar -->
    <aside class="sidebar">
      <h1 class="sidebar-title rainbow-text">Tools Collection</h1>
      <nav>
        <ul class="sidebar-nav">
          <li class="sidebar-nav-item">
            <a href="" class="sidebar-nav-link active" data-section="home" aria-label="Home">
              <span class="sidebar-nav-icon"><i class="fa-solid fa-house"></i></span>
              <span>Home</span>
            </a>
          </li>
          <li class="sidebar-nav-item">
            <a href="" class="sidebar-nav-link" id="private-link" data-section="private" aria-label="Private Tools">
              <span class="sidebar-nav-icon"><i class="fa-solid fa-lock"></i></span>
              <span>Private Tools</span>
            </a>
          </li>
          <li class="sidebar-nav-item">
            <a href="" class="sidebar-nav-link" data-section="new" aria-label="New">
              <span class="sidebar-nav-icon"><i class="fa-solid fa-wand-magic-sparkles"></i></span>
              <span>New</span>
            </a>
          </li>

          <!-- Theme toggle in sidebar -->
          <li class="theme-toggle-item" aria-label="Theme toggle">
            <span>Theme</span>
            <button id="theme-toggle-desktop" class="icon-toggle" aria-label="Toggle theme"
              title="Toggle theme">ðŸŒ™</button>
          </li>
        </ul>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Home Section -->
      <section id="home-section" class="content-section active">
        <div class="container">
          <h1 class="rainbow-text"><i class="fas fa-toolbox"></i> Basic Collection</h1>

          <div class="tools-grid">

            <div class="tool-card">
              <h2><span class="icon"><i class="fa-solid fa-flag"></i></span> Country Flag Quiz</h2>
              <p>Guess the country from its flag.</p>
              <a href="#home-flag" class="tool-link">Play Flag Guesser</a>
            </div>

            <div class="tool-card">
              <h2><span class="icon"><i class="fa-solid fa-arrows-rotate"></i></span> Placeholder</h2>
              <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Officiis soluta mollitia deserunt est
                corrupti, voluptas cum dolorum neque odit dicta itaque accusantium molestiae dignissimos, laborum nemo?
                Ad eos vel temporibus?</p>
              <a href="#" class="tool-link">Open</a>
            </div>

          </div>
        </div>
      </section>

      <!-- Private Section (only shown after correct password) -->
      <section id="private-section" class="content-section">
        <div class="container">
          <h1 class="rainbow-text"><i class="fas fa-lock"></i> Private</h1>
          <div class="tools-grid">

            <div class="tool-card">
              <h2><span class="icon"><i class="fa-solid fa-arrows-rotate"></i></span> Placeholder</h2>
              <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Officiis soluta mollitia deserunt est
                corrupti, voluptas cum dolorum neque odit dicta itaque accusantium molestiae dignissimos, laborum nemo?
                Ad eos vel temporibus?</p>
              <a href="#" class="tool-link">Open</a>
            </div>

          </div>
        </div>
      </section>

      <!-- New Section -->
      <section id="new-section" class="content-section">
        <div class="container">
          <h1 class="rainbow-text"><i class="fas fa-star"></i> Upcoming</h1>
          <div class="tools-grid">

            <div class="tool-card">
              <h2><span class="icon"><i class="fa-solid fa-book-open"></i></span> Idioms Library</h2>
              <p>Browse over two thousands of idioms with quick meanings.</p>
              <a href="#new-idiom" class="tool-link">Read Idioms</a>
            </div>

            <div class="tool-card">
              <h2><span class="icon"><i class="fa-solid fa-arrows-rotate"></i></span> Placeholder</h2>
              <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Officiis soluta mollitia deserunt.</p>
              <a href="#" class="tool-link">Open</a>
            </div>

          </div>
        </div>
      </section>

      <!-- Dynamic Route Host (for loading external tool pages) -->
      <section id="dynamic-section" class="content-section" data-dynamic="true">
        <div id="dynamic-host"></div>
      </section>
    </main>
  </div>

  <!-- Mobile Navigation -->
  <nav class="mobile-nav" aria-label="Primary">
    <a href="" class="mobile-nav-item active" data-section="home" aria-label="Home">
      <span class="mobile-nav-icon"><i class="fa-solid fa-house"></i></span>
      <span class="mobile-nav-text">Home</span>
    </a>
    <a href="" class="mobile-nav-item" id="mobile-private-link" data-section="private" aria-label="Private">
      <span class="mobile-nav-icon"><i class="fa-solid fa-lock"></i></span>
      <span class="mobile-nav-text">Private</span>
    </a>
    <a href="" class="mobile-nav-item" data-section="new" aria-label="New">
      <span class="mobile-nav-icon"><i class="fa-solid fa-wand-magic-sparkles"></i></span>
      <span class="mobile-nav-text">New</span>
    </a>

    <!-- Theme toggle in mobile bar -->
    <button class="mobile-nav-item icon-toggle" id="theme-toggle-mobile" aria-label="Toggle theme"
      title="Toggle theme">ðŸŒ™</button>
  </nav>

  <!-- Password Modal -->
  <div class="password-modal" id="password-modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="password-modal-content">
      <h2><i class="fa-solid fa-key"></i> Enter Password</h2>
      <form id="password-form" autocomplete="off" novalidate>
        <input type="password" id="password-input" placeholder="Password required" autocomplete="off">
        <div class="modal-buttons">
          <button id="cancel-password" type="button">Cancel</button>
          <button id="submit-password" type="button">Submit</button>
        </div>
        <p class="password-error" id="password-error">Incorrect password</p>
      </form>
    </div>
  </div>

  <!-- Global Center Loader -->
  <div id="global-loader" class="global-loader" aria-hidden="true">
    <div class="dots" aria-label="Loading">
      <div class="dot"></div>
      <div class="dot"></div>
      <div class="dot"></div>
    </div>
  </div>

  <script src="js/main.theme.js"></script>
  <script src="js/main.hash.js"></script>
  <script src="js/main.routes.js"></script>

  <script>
    (function () {
      // Global script loader
      const LOADED_SCRIPTS = new Set();
      async function loadScriptOnce(src) {
        if (!src || LOADED_SCRIPTS.has(src)) return;
        await new Promise((resolve) => {
          const s = document.createElement('script');
          s.src = src;
          s.async = false;
          s.onload = () => { LOADED_SCRIPTS.add(src); resolve(); };
          s.onerror = () => resolve();
          document.head.appendChild(s);
        });
      }
      window.loadScriptOnce = loadScriptOnce;

      const PAK = 'tools:pakaccess';
      let hasPrivateAccess = sessionStorage.getItem(PAK) === '1';
      let pendingPrivateRoute = null;

      // Password Modal wiring
      const modal = document.getElementById('password-modal');
      const form = document.getElementById('password-form');
      const input = document.getElementById('password-input');
      const errorEl = document.getElementById('password-error');
      const submitBtn = document.getElementById('submit-password');
      const cancelBtn = document.getElementById('cancel-password');

      function openPasswordModal() {
        modal?.classList.add('show');
        modal?.setAttribute('aria-hidden', 'false');
        if (errorEl) errorEl.style.display = 'none';
        if (input) { input.value = ''; setTimeout(() => input.focus(), 0); }
      }

      function closePasswordModal() {
        modal?.classList.remove('show');
        modal?.setAttribute('aria-hidden', 'true');
      }

      function validatePassword(pw) {
        if (typeof window.validatePrivatePassword === 'function') {
          try { return !!window.validatePrivatePassword(pw); } catch { return false; }
        }
        if (typeof window.PRIVATE_PASSWORD === 'string') return pw === window.PRIVATE_PASSWORD;
        return false;
      }

      function clearHashToHome() {
        const url = window.location.pathname + window.location.search;
        history.replaceState(null, '', url);
      }

      function handlePasswordSubmit() {
        const pw = input ? input.value : '';
        const ok = validatePassword(pw);
        if (ok) {
          hasPrivateAccess = true;
          try { sessionStorage.setItem(PAK, '1'); } catch { }
          if (errorEl) errorEl.style.display = 'none';
          closePasswordModal();

          // If user originally requested a private child route, go there after unlock
          if (pendingPrivateRoute) {
            const target = pendingPrivateRoute;
            pendingPrivateRoute = null;
            navigate(target);
          } else {
            navigate('private');
          }

          document.dispatchEvent(new CustomEvent('privateAccessGranted', { detail: { at: Date.now() } }));
        } else {
          if (errorEl) errorEl.style.display = 'block';
          input?.focus();
        }
      }

      form?.addEventListener('submit', (e) => {
        e.preventDefault();
        handlePasswordSubmit();
      });

      submitBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        handlePasswordSubmit();
      });

      cancelBtn?.addEventListener('click', () => {
        closePasswordModal();
        pendingPrivateRoute = null;
        clearHashToHome();
        showSection('home');
      });

      input?.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') { e.preventDefault(); cancelBtn?.click(); }
      });

      document.addEventListener('passwordRequested', openPasswordModal);

      // Router helpers
      const dynamicHost = document.getElementById('dynamic-host');
      let currentDynamic = null;        // dynamic route currently mounted
      let isLoadingDynamic = false;     // prevent duplicate async loads

      function resolveRoute(route) {
        if (DYNAMIC_ROUTES[route]?.aliasOf) return DYNAMIC_ROUTES[route].aliasOf;
        return route;
      }

      // determine if a route is private (root private or any child under private)
      function isPrivateRoute(sectionId) {
        if (sectionId === 'private') return true;
        const def = DYNAMIC_ROUTES[sectionId];
        if (!def) return false;
        return def.parent === 'private' || def.private === true || def.requiresAuth === true;
      }

      function visibleTargetFor(sectionId) {
        // Gate both the private index and any private child route
        if (isPrivateRoute(sectionId) && !hasPrivateAccess) return 'home';
        if (STATIC_SECTIONS.includes(sectionId)) return sectionId;
        if (DYNAMIC_ROUTES[sectionId]) return 'dynamic';
        return 'home';
      }

      function setActiveNav(targetId) {
        document.querySelectorAll('.sidebar-nav-link, .mobile-nav-item').forEach(item => item.classList.remove('active'));
        let navKey = targetId;
        if (DYNAMIC_ROUTES[targetId]?.parent) navKey = DYNAMIC_ROUTES[targetId].parent;
        if (navKey === 'private' && !hasPrivateAccess) navKey = 'home';
        document.querySelectorAll(`.sidebar-nav-link[data-section="${navKey}"], .mobile-nav-item[data-section="${navKey}"]`).forEach(item => {
          item.classList.add('active');
        });
      }

      function sanitizeCloneWithoutScripts(el) {
        const wrapper = el.cloneNode(false);
        for (let child = el.firstChild; child; child = child.nextSibling) {
          if (child.nodeType === Node.ELEMENT_NODE && child.tagName.toLowerCase() === 'script') continue;
          wrapper.appendChild(child.cloneNode(true));
        }
        return wrapper;
      }

      async function loadExternalView(routeKey) {
        const def = DYNAMIC_ROUTES[routeKey];
        if (!def || !def.file) return;

        if (isLoadingDynamic) return;
        isLoadingDynamic = true;
        currentDynamic = routeKey; // mark intent early

        showGlobalLoader(300);
        dynamicHost.innerHTML = '';

        try {
          const res = await fetch(def.file, { cache: 'no-cache' });
          const html = await res.text();

          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const viewRoot = doc.querySelector('[data-view-root]') || doc.body || doc;

          // Inject wrapper (without scripts)
          const wrapperClone = sanitizeCloneWithoutScripts(viewRoot);
          dynamicHost.appendChild(wrapperClone);

          // Execute scripts in order
          const scripts = Array.from(viewRoot.querySelectorAll('script'));
          for (const s of scripts) {
            if (s.src) {
              await loadScriptOnce(s.src);
            } else {
              const el = document.createElement('script');
              el.textContent = s.textContent || '';
              dynamicHost.appendChild(el);
            }
          }

          dynamicHost.dispatchEvent(new CustomEvent('spa:view:mounted', { detail: { route: routeKey, host: dynamicHost } }));
        } catch (e) {
          dynamicHost.innerHTML = `<div class="container"><p style="color:var(--error);">Failed to load ${def.title || 'view'}.</p></div>`;
          currentDynamic = null; // allow retry
        } finally {
          isLoadingDynamic = false;
        }
      }

      function showSection(sectionId) {
        const toShow = visibleTargetFor(sectionId);
        document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
        if (toShow === 'dynamic') {
          document.getElementById('dynamic-section').classList.add('active');
          if (sectionId !== currentDynamic && !isLoadingDynamic) {
            loadExternalView(sectionId);
          } else {
            showGlobalLoader(300);
          }
        } else {
          if (currentDynamic && toShow !== 'dynamic') {
            dynamicHost.innerHTML = '';
            currentDynamic = null;
          }
          const el = document.getElementById(`${toShow}-section`);
          if (el) el.classList.add('active');
          showGlobalLoader(300);
        }

        setActiveNav(sectionId);
        document.dispatchEvent(new CustomEvent('navigate', { detail: { section: sectionId, visible: toShow } }));
      }

      function navigate(sectionId) {
        const resolved = resolveRoute(sectionId);
        showGlobalLoader(300);

        // Gate private routes (root and children)
        if (isPrivateRoute(resolved) && !hasPrivateAccess) {
          pendingPrivateRoute = resolved;         // remember where the user wanted to go
          if (window.location.hash !== '#private') {
            window.location.hash = 'private';     // normalize hash to private index
          }
          openPasswordModal();
          showSection('home');                    // keep user on home until unlocked
          return;
        }

        if (resolved === 'home') {
          const was = window.location.hash;
          if (was) {
            const url = window.location.pathname + window.location.search;
            history.pushState(null, '', url);
          }
          const url = window.location.pathname + window.location.search;
          history.replaceState(null, '', url);
          showSection('home');
          return;
        }

        if (window.location.hash !== `#${resolved}`) {
          window.location.hash = resolved; // hashchange will render
        } else {
          showSection(resolved);
        }
      }

      function handleHashChange() {
        const raw = window.location.hash || '';
        const section = resolveRoute((raw.replace('#', '').trim() || 'home'));

        // Gate on reload/direct hash for private child routes too
        if (isPrivateRoute(section) && !hasPrivateAccess) {
          pendingPrivateRoute = section;
          openPasswordModal();
          showSection('home');
          return;
        }

        showSection(section);
      }

      // Bind navigation clicks
      document.querySelectorAll('.sidebar-nav-link[data-section], .mobile-nav-item[data-section]').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const section = link.getAttribute('data-section');
          navigate(section);
        });
      });

      // Route in-page route links
      document.addEventListener('click', (e) => {
        const a = e.target.closest('a[href^="#"]');
        if (!a) return;
        const hash = a.getAttribute('href').slice(1);
        if (!hash) return;
        e.preventDefault();
        navigate(hash);
      });

      window.addEventListener('hashchange', handleHashChange);
      handleHashChange(); // initial
    })();
  </script>
</body>

</html>